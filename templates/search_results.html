<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>×ª×•×¦××•×ª ×—×™×¤×•×©</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='results.css') }}">
</head>
<body>

<div class="top-bar">
  <a href="{{ url_for('entry') }}" class="home-btn" title="××¡×š ×‘×™×ª">
    <img src="{{ url_for('static', filename='home_icon.png') }}" alt="××¡×š ×‘×™×ª">
  </a>
</div>

<div class="results-container">
  <h2 class="results-title">×›×™×ª×•×ª ×¤× ×•×™×•×ª</h2>

  {# =========================
     ××¦×‘ 1: ×¡×˜×•×“× ×˜ (slots)
     ========================= #}
  {% if slots is defined and slots and slots|length > 0 %}

    <div class="big-box">
      <p class="title">×ª××¨×™×š: {{ today_date_display or today_date }}</p>
    </div>

    {% for s in slots %}
      <div class="big-box">
        <p class="subtitle">{{ s.start }}-{{ s.end }}</p>
      </div>

      <div class="rooms-grid">
        {% for room in s.rooms %}

          {% set rt = room["room_type"] %}
          {% set seats = room["seats"] if room["seats"] is not none else "â€”" %}
          {% set comps = room["computer_stations"] if room["computer_stations"] is not none else "â€”" %}
          {% set has_proj = (room["has_projector"]|int == 1) %}

          <div class="room-card">

            <!-- ××™×™×§×•×Ÿ ××™×“×¢ -->
            <div class="info-wrap" tabindex="0">
              <span class="info-icon">!</span>

              <div class="tooltip-box">
                {% if rt == "computers" %}
                  <div class="tip-title">×›×™×ª×ª ××—×©×‘×™×</div>
                  <div class="tip-line">{{ comps }} ×¢××“×•×ª ××—×©×‘</div>
                {% elif rt == "lab" %}
                  <div class="tip-title">×›×™×ª×ª ××¢×‘×“×”</div>
                  <div class="tip-line">{{ seats }} ×›×™×¡××•×ª</div>
                {% else %}
                  <div class="tip-title">×›×™×ª×” ×¨×’×™×œ×”</div>
                  <div class="tip-line">{{ seats }} ×›×™×¡××•×ª</div>
                {% endif %}

                <div class="tip-line">
                  {% if has_proj %}
                    ×™×© ××§×¨×Ÿ
                  {% else %}
                    ××™×Ÿ ××§×¨×Ÿ
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="card-header">
              ğŸ« {{ room["name"] }}
            </div>

            <form method="POST" action="{{ url_for('book_room') }}">
              <input type="hidden" name="room" value="{{ room['code'] }}">
              <input type="hidden" name="date" value="{{ today_date }}">
              <input type="hidden" name="start_time" value="{{ s.start }}">
              <input type="hidden" name="end_time" value="{{ s.end }}">

              <button class="reserve-btn" type="submit">×©×¨×™×™×Ÿ ×›×™×ª×”</button>
            </form>
          </div>

        {% endfor %}
      </div>
    {% endfor %}

  {# =========================
     ××¦×‘ 2: ××¨×¦×” (free_blocks)
     ========================= #}
  {% elif free_blocks is defined and free_blocks and free_blocks|length > 0 %}

    <div class="rooms-grid">
      {% for b in free_blocks %}

        {% set rt = b["room_type"] %}
        {% set seats = b["seats"] if b["seats"] is not none else "â€”" %}
        {% set comps = b["computer_stations"] if b["computer_stations"] is not none else "â€”" %}
        {% set has_proj = (b["has_projector"]|int == 1) %}

        {# ×ª××¨×™×š ×‘×¤×•×¨××˜ DD-MM-YYYY #}
        {% set dparts = b.date.split('-') %}
        {% set date_display = dparts[2] ~ '-' ~ dparts[1] ~ '-' ~ dparts[0] %}

        <div class="room-card">

          <!-- ××™×™×§×•×Ÿ ××™×“×¢ -->
          <div class="info-wrap" tabindex="0">
            <span class="info-icon">!</span>

            <div class="tooltip-box">
              {% if rt == "computers" %}
                <div class="tip-title">×›×™×ª×ª ××—×©×‘×™×</div>
                <div class="tip-line">{{ comps }} ×¢××“×•×ª ××—×©×‘</div>
              {% elif rt == "lab" %}
                <div class="tip-title">×›×™×ª×ª ××¢×‘×“×”</div>
                <div class="tip-line">{{ seats }} ×›×™×¡××•×ª</div>
              {% else %}
                <div class="tip-title">×›×™×ª×” ×¨×’×™×œ×”</div>
                <div class="tip-line">{{ seats }} ×›×™×¡××•×ª</div>
              {% endif %}

              <div class="tip-line">
                {% if has_proj %}
                  ×™×© ××§×¨×Ÿ
                {% else %}
                  ××™×Ÿ ××§×¨×Ÿ
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card-header">
            ğŸ« {{ b.name }}
          </div>

          <div class="card-info">
            <p>×˜×•×•×— ×¤× ×•×™: {{ b.free_start }}-{{ b.free_end }}</p>
            <p>×ª××¨×™×š: {{ date_display }}</p>
          </div>

          <!-- ×˜×•×¤×¡ ×©×¨×™×•×Ÿ ×—×œ×§×™ ×œ××¨×¦×” -->
          <form class="lecturer-book-form"
                method="POST"
                action="{{ url_for('book_room') }}"
                data-free-start="{{ b.free_start }}"
                data-free-end="{{ b.free_end }}">

            <input type="hidden" name="room" value="{{ b.code }}">
            <input type="hidden" name="date" value="{{ b.date }}">

            <!-- × ×©×œ×—×™× ×‘×¤×•×¢×œ ×œ×©×¨×ª -->
            <input type="hidden" name="start_time" class="hidden-start">
            <input type="hidden" name="end_time" class="hidden-end">

            <div class="time-pick-wrap">
              <div class="time-pick">
                <label class="time-label">×©×¢×ª ×”×ª×—×œ×”:</label>
                <select class="pick-start" dir="ltr" required></select>
              </div>

              <div class="time-pick">
                <label class="time-label">×©×¢×ª ×¡×™×•×:</label>
                <select class="pick-end" dir="ltr" required></select>
              </div>
            </div>

            <button class="reserve-btn" type="submit">×©×¨×™×™×Ÿ ×›×™×ª×”</button>
          </form>
        </div>

      {% endfor %}
    </div>

  {% else %}
    <p style="color: white; text-align: center; width: 100%;">
      ×œ× × ××¦××• ×›×™×ª×•×ª ×¤× ×•×™×•×ª ×‘×©×¢×•×ª ××œ×•.
    </p>
  {% endif %}
</div>

<script>
/* ---- Lecturer partial time picker (client-side) ---- */

function toMin(t){
  const parts = (t || "").split(":").map(Number);
  if(parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) return NaN;
  return parts[0]*60 + parts[1];
}
function toHHMM(total){
  const h = Math.floor(total/60);
  const m = total%60;
  return String(h).padStart(2,'0') + ":" + String(m).padStart(2,'0');
}
function buildTimes(startHHMM, endHHMM, stepMin){
  const s = toMin(startHHMM);
  const e = toMin(endHHMM);
  if(isNaN(s) || isNaN(e) || e <= s) return [];
  const out = [];
  for(let x=s; x<=e; x+=stepMin){
    out.push(toHHMM(x));
  }
  return out;
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".lecturer-book-form").forEach(form => {
    const freeStart = form.dataset.freeStart; // "HH:MM"
    const freeEnd   = form.dataset.freeEnd;   // "HH:MM"

    const startSel = form.querySelector(".pick-start");
    const endSel   = form.querySelector(".pick-end");

    const hiddenStart = form.querySelector(".hidden-start");
    const hiddenEnd   = form.querySelector(".hidden-end");

    if(!startSel || !endSel || !hiddenStart || !hiddenEnd) return;

    // ××¤×©×¨ ×œ×©× ×•×ª ×œ-15 ×× ×ª×¨×¦×” ×¨×–×•×œ×•×¦×™×” ×™×•×ª×¨ ×’×‘×•×”×”
    const STEP = 30;

    const times = buildTimes(freeStart, freeEnd, STEP);

    // start ×™×›×•×œ ×œ×”×™×•×ª ×¢×“ ×œ×¤× ×™ ×”××—×¨×•×Ÿ (×›×™ ×—×™×™×‘ ×œ×”×™×•×ª end ××—×¨×™×•)
    const startOptions = times.slice(0, Math.max(0, times.length - 1));
    startSel.innerHTML = startOptions.map(t => `<option value="${t}">${t}</option>`).join("");

    function refreshEnd(){
      const sVal = startSel.value;
      const sMin = toMin(sVal);
      const endOptions = times.filter(t => toMin(t) > sMin);
      endSel.innerHTML = endOptions.map(t => `<option value="${t}">${t}</option>`).join("");

      if(endOptions.length > 0){
        endSel.value = endOptions[0];
      }
    }

    // init
    if(startOptions.length > 0){
      startSel.value = startOptions[0];
      refreshEnd();
    }

    startSel.addEventListener("change", refreshEnd);

    form.addEventListener("submit", (e) => {
      const s = startSel.value;
      const en = endSel.value;

      if(!s || !en || toMin(en) <= toMin(s)){
        e.preventDefault();
        alert("×‘×—×¨ ×˜×•×•×— ×©×¢×•×ª ×ª×§×™×Ÿ (×¡×™×•× ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ ×”×ª×—×œ×”).");
        return;
      }

      hiddenStart.value = s;
      hiddenEnd.value = en;
    });
  });
});
</script>

</body>
</html>
